{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}{{ product.name }} - Detalle{% endblock %}

{% block meta_description %}
    {% if product.meta_description %}
        {{ product.meta_description }}
    {% else %}
        Detalles del producto {{ product.name }}
    {% endif %}
{% endblock %}

{% block content %}
    <h1>{{ product.name }}</h1>
    <p>Uva: {{ product.grape }} | Notas: {{ product.notes }}</p>
    {% if product.image %}<img src="{{ product.image.url }}" alt="{{ product.name }}" width="300">{% endif %}
    
    <h2>Variantes disponibles</h2>
    {% for variant in product.prefetched_variants %}
        <div class="variant-card">
            <p>Año: {{ variant.vintage|default:"N/A" }} | Volumen: {{ variant.volume_ml|default:"N/A" }} ml | ABV: {{ variant.abv|default:"N/A" }}%</p>
            {% for price in variant.prefetched_prices %}
                <p>Precio: {{ price.sale_amount }}€ (desde {{ price.valid_from }})</p>
            {% endfor %}
            {% for stock in variant.prefetched_stock %}
                <p>Stock en {{ stock.store.name }}: {{ stock.on_hand }}</p>
            {% endfor %}
            <button onclick="addToCart('{{ variant.id }}')">Añadir al Carrito</button>  <!-- Llama a JS o view para cart -->
        </div>
    {% empty %}
        <p>No hay variantes disponibles para este producto.</p>
    {% endfor %}
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function addToCart(variantId) {
    fetch(`/cart/add/${variantId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ quantity: 1 })
    })
    .then(response => {
        if (response.ok) {
            alert('Producto añadido');  // O actualiza UI
        } else {
            alert('Error');
        }
    })
    .catch(error => console.error('Error:', error));
}
</script>

{% endblock %}
